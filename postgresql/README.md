## PostgreSQL Database Scripts - Iridium M2M Reporting (TESTING)

**Назначение**: Тестовая база данных для разработки и отладки отчетов

## Структура папок

```
postgresql/
├── tables/          # DDL для создания таблиц (тестовая копия Oracle структуры)
├── views/           # Представления для отчетов (PostgreSQL версии)
├── functions/       # PostgreSQL функции
├── data/           # Тестовые данные
├── scripts/        # Скрипты для загрузки данных из Oracle
└── README.md       # Этот файл
```

## ⚠️ Важно: Production vs Testing

- **Oracle** (`oracle/`) - **PRODUCTION** база данных (billing7@bm7)
  - Реальные данные из SPNet и STECCOM
  - Интеграция с биллингом
  - Используется в production Streamlit

- **PostgreSQL** (`postgresql/`) - **TESTING** база данных (localhost:5432)
  - Копия данных из Oracle для тестирования
  - Локальная разработка без доступа к Oracle
  - Тестирование функций и представлений

## Порядок установки

### 1. Создание базы данных

```bash
# Создать базу данных
psql -U postgres -c "CREATE DATABASE billing;"

# Или использовать существующую
psql -U postgres -d billing
```

### 2. Создание структуры

```bash
cd postgresql

# Создать таблицы
psql -U postgres -d billing -f tables/install_all_tables.sql

# Загрузить справочные данные
psql -U postgres -d billing -f data/tariff_plans_data.sql

# Создать функции
psql -U postgres -d billing -f functions/calculate_overage.sql

# Создать представления
cd views
psql -U postgres -d billing -f install_all_views.sql
```

### 3. Загрузка данных

#### Вариант A: Из CSV файлов (как в Oracle)

```bash
cd ../../python
python load_spnet_traffic.py     # Загрузка SPNet
python load_steccom_expenses.py  # Загрузка STECCOM
```

#### Вариант B: Копирование из Oracle (для тестирования)

```bash
cd postgresql/scripts
python load_from_oracle_views.py
```

Этот скрипт копирует данные из Oracle production в PostgreSQL testing.

## Описание объектов

### Таблицы

1. **SPNET_TRAFFIC** - данные трафика SPNet
2. **STECCOM_EXPENSES** - расходы STECCOM
3. **TARIFF_PLANS** - справочник тарифов
4. **LOAD_LOGS** - журнал загрузок

### Функции

**calculate_overage(plan_name VARCHAR, usage_bytes NUMERIC)**
- Расчет стоимости превышения трафика
- PostgreSQL версия Oracle функции

### Представления

1. **V_SPNET_OVERAGE_ANALYSIS**
   - Анализ превышений по IMEI
   - Источник: SPNET_TRAFFIC + TARIFF_PLANS

2. **V_CONSOLIDATED_OVERAGE_REPORT**
   - Консолидированный отчет
   - Источник: V_SPNET_OVERAGE_ANALYSIS + STECCOM_EXPENSES

## Использование в Streamlit

### Для тестирования локально

```bash
# Использовать streamlit_report.py (PostgreSQL версия)
streamlit run streamlit_report.py --server.port 8502
```

Этот файл подключается к PostgreSQL на localhost.

### Для production

```bash
# Использовать streamlit_report_oracle.py
streamlit run streamlit_report_oracle.py --server.port 8501
```

Этот файл подключается к Oracle billing7@bm7.

## Отличия PostgreSQL от Oracle

### Синтаксис SQL

| Oracle | PostgreSQL |
|--------|-----------|
| `NUMBER` | `NUMERIC`, `INTEGER` |
| `VARCHAR2` | `VARCHAR` |
| `NVL()` | `COALESCE()` |
| `SYSDATE` | `CURRENT_TIMESTAMP` |
| `GENERATED BY DEFAULT AS IDENTITY` | `SERIAL` |
| `DATE` | `TIMESTAMP`, `DATE` |
| `MOD(x, y)` | `x % y` |
| `TRUNC(x)` | `x / y` (integer division) |

### Драйвер Python

- Oracle: `cx_Oracle`
- PostgreSQL: `psycopg2`

## Примеры использования

### Проверка данных

```sql
-- Количество записей
SELECT 
    'SPNET_TRAFFIC' as table_name, COUNT(*) as records
FROM SPNET_TRAFFIC
UNION ALL
SELECT 'STECCOM_EXPENSES', COUNT(*)
FROM STECCOM_EXPENSES;

-- Проверка представлений
SELECT * FROM V_CONSOLIDATED_OVERAGE_REPORT LIMIT 10;
```

### Тестирование функции

```sql
-- Тест расчета превышения
SELECT 
    'SBD-1, 30 KB' as test_case,
    calculate_overage('SBD Tiered 1250 1K', 30000) as result,
    27.25 as expected;
```

## Синхронизация с Oracle

Для обновления тестовых данных из production:

```bash
cd postgresql/scripts
python load_from_oracle_views.py
```

Скрипт:
1. Подключается к Oracle (billing7@bm7)
2. Читает данные из SPNET_TRAFFIC и STECCOM_EXPENSES
3. Очищает PostgreSQL таблицы
4. Загружает свежие данные

## Настройки подключения

### PostgreSQL (по умолчанию)

```python
POSTGRES_CONFIG = {
    'host': 'localhost',
    'port': 5432,
    'database': 'billing',
    'user': 'postgres',
    'password': '1234'
}
```

### Oracle (source)

```python
ORACLE_CONFIG = {
    'user': 'billing7',
    'password': 'billing',
    'dsn': 'bm7'
}
```

## Преимущества PostgreSQL для тестирования

✅ Локальная установка - не нужен доступ к Oracle  
✅ Быстрее для разработки  
✅ Бесплатная лицензия  
✅ Хорошая поддержка Python (psycopg2)  
✅ Легко сбросить и пересоздать БД  

## Ограничения PostgreSQL

⚠️ Нет доступа к биллингу (SERVICES, ACCOUNTS, CUSTOMERS)  
⚠️ V_IRIDIUM_SERVICES_INFO не работает (требует billing7@bm7)  
⚠️ V_CONSOLIDATED_REPORT_WITH_BILLING не работает  

Для полной функциональности с данными клиентов используйте Oracle.

## Поддержка

- Oracle (production): см. [../oracle/README.md](../oracle/README.md)
- Документация: см. [../docs/INDEX.md](../docs/INDEX.md)





