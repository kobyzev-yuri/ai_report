# Формирование KB из корпоративного Confluence

Краткая справка по подходу к построению базы знаний (KB) из данных Confluence.

**Идея:** расширить единую векторную базу (Qdrant) с биллинга на сектор **спутниковых инженеров**: они хранят схемы сети и документацию в Confluence компании. Одна коллекция Qdrant (например `kb_billing`) содержит и биллинг (SQL-примеры, таблицы, метаданные), и документы из Confluence с меткой домена `satellite` — так получается единая KB по разным аспектам деятельности СТЭККОМ и ассистент по спутниковым системам на её основе.

**Наполнение KB по сектору спутниковых систем** идёт не на примерах SQL (как в биллинге), а **так, как подразумевается структурой в Confluence**: страницы → секции и подсекции (h1–h6), текст, ссылки на источник. То есть это справочные документы (reference), по которым RAG ищет релевантные фрагменты и отвечает на вопросы инженеров; отдельного «обучения на примерах запросов» для Confluence не делаем.

**Все ссылки в документе относятся к референсному проекту [steccom-rag-lk](../steccom-rag-lk/):** отчёты `FINAL_WORK_SUMMARY.md`, `GITHUB_SAVE_REPORT.md`, шаблон по MediaWiki (`scripts/generate_knowledge_base.py`, `modules/integrations/mediawiki_client.py`). В самом steccom-rag-lk кода Confluence в репозитории может не быть — документ описывает целевую схему и референс по архитектуре. В **боевом проекте** (текущий репозиторий ai_report) интеграция Confluence реализована в `kb_billing/rag/` (см. раздел «Реализация в ai_report» в конце).

---

## 1. Общая схема

- **Источник:** корпоративный Confluence (REST API).
- **Аутентификация:** Bearer-токен (Personal Access Token или аналог).
- **Направление для KB:** Confluence → извлечение страниц → преобразование в единый формат KB → сохранение в файлы/БД и загрузка в RAG.

Дополнительно в песочнице были: публикация из KB обратно в Confluence (update/create), обработка вложений Draw.io, использование Confluence как источника в «Умном библиотекаре» (файлы + Confluence).

---

## 2. Компоненты (референс — проект steccom-rag-lk)

| Компонент | Путь в steccom-rag-lk | Назначение |
|-----------|------------------------|------------|
| Confluence client | `modules/integrations/confluence_client.py` | Клиент к Confluence REST API (список страниц/пространств, получение тела страницы, при необходимости — вложения). |
| UI Confluence | `kb_admin/modules/ui/confluence_interface.py` | UI в KB Admin: выбор пространства/страниц, запуск выгрузки, отображение результатов. |
| Smart Librarian | — | Confluence как один из источников документов наряду с файлами; при необходимости — анализ Draw.io, OCR для изображений. |

Конфигурация: в настройках задаётся `CONFLUENCE_TOKEN` (и при необходимости URL Confluence, пространство по умолчанию).

---

## 3. Формат KB (целевой)

Формат совпадает с тем, что используется при экспорте из MediaWiki в steccom-rag-lk (см. `../steccom-rag-lk/scripts/generate_knowledge_base.py`). Один документ KB — один JSON-объект в массиве:

```json
{
  "title": "Название страницы",
  "audience": ["user", "admin"],
  "scope": ["general"],
  "status": "reference",
  "content": [
    {
      "title": "Раздел 1",
      "text": "Текст раздела...",
      "subsections": []
    }
  ],
  "source": {
    "type": "confluence",
    "url": "https://confluence.company.com/...",
    "last_updated": "2025-10-21T12:00:00"
  }
}
```

- **title** — заголовок страницы Confluence.
- **audience / scope / status** — при отсутствии в Confluence задаются значениями по умолчанию (как в MediaWiki: `["user", "admin"]`, `["general"]`, `"reference"`); при наличии макросов/разметки можно парсить из тела или метаданных.
- **content** — секции с заголовками и текстом; для Confluence получаются из HTML/Storage-формата (см. ниже).
- **source** — тип `confluence`, ссылка на страницу и дата обновления.

---

## 4. Пошаговый пайплайн Confluence → KB

1. **Настройка**
   - URL Confluence (например `https://confluence.company.com`).
   - Bearer-токен с правами на чтение нужных пространств/страниц.
   - При необходимости: ID или ключ пространства по умолчанию, лимиты (макс. страниц за запуск).

2. **Получение списка страниц**
   - REST API: например `GET /rest/api/content?spaceKey=...&expand=body.storage,version` или обход по пространству(ам).
   - Фильтрация при необходимости: по меткам, типу страницы, дате изменения.

3. **Извлечение контента**
   - Для каждой страницы: тело в формате Storage (HTML-подобная разметка Confluence) или view.
   - Парсинг: удаление служебных тегов, извлечение заголовков (h1–h6) в секции и подсекции, текст — в поля `title`/`text`/`subsections` формата KB.
   - Обработка макросов: таблицы → текст/Markdown, Draw.io — отдельно (см. ниже).

4. **Draw.io и вложения**
   - Определение макросов Draw.io в разметке; при необходимости — выгрузка XML/PNG и либо сохранение как вложение с метаданными, либо текстовая выжимка/OCR для поиска.
   - Остальные вложения (PDF, картинки) — по политике проекта: ссылка в `source`, отдельная выгрузка и индексация или пропуск.

5. **Сборка и сохранение**
   - Каждая страница → один элемент массива KB в формате выше.
   - Сохранение: в JSON-файл(ы) (например `docs/kb/confluence_<space>.json` в steccom-rag-lk или `kb_billing/confluence_docs/confluence_<space>.json` в ai_report) и/или в БД документов KB (как в загрузчиках RAG).
   - При повторных запусках — обновление по `id`/`url` страницы и `last_updated`.

6. **Загрузка в RAG**
   - Те же механизмы, что и для KB из файлов: загрузка JSON в RAG (см. `api/main.py` эндпоинт `/rag/load-kb-files`, скрипты загрузки KB), обновление векторного хранилища.

---

## 5. Референс по архитектуре (MediaWiki) — проект steccom-rag-lk

Логика «источник → единый формат KB → RAG» в steccom-rag-lk реализована для MediaWiki и служит шаблоном для Confluence:

- **Клиент:** `../steccom-rag-lk/modules/integrations/mediawiki_client.py` — аутентификация, `get_page_content`, `search_pages`.
- **Генератор KB:** `../steccom-rag-lk/scripts/generate_knowledge_base.py` — получение страниц, парсинг разметки в структуру с `title`, `audience`, `scope`, `status`, `content`, `source`; сохранение в JSON.
- **Загрузка в RAG:** чтение KB JSON и передача в RAG (как в API и скриптах загрузки в steccom-rag-lk).

Для Confluence реализуется аналог: **ConfluenceClient** (REST + Bearer) и **ConfluenceKBGenerator** (список страниц → получение тела → парсинг Storage/HTML в тот же формат KB → сохранение).

---

## 6. Что учесть в боевом проекте

- **Токены:** не хранить в коде; использовать переменные окружения или секретное хранилище (`CONFLUENCE_URL`, `CONFLUENCE_TOKEN`).
- **Лимиты и пагинация:** Confluence API может ограничивать число записей за запрос — обход по `start`, `limit` или cursor.
- **Инкрементальное обновление:** сохранять последнюю дату синхронизации и подтягивать только изменённые страницы (по `version.when` или аналогу).
- **Права доступа:** токен с минимальными правами на чтение нужных пространств; при наличии персональных страниц — фильтрация по пространству/меткам.
- **Draw.io/OCR:** при необходимости подключать тот же подход, что и в Smart Librarian (выделение макросов, при необходимости — Gemini/другой OCR для изображений).

---

## 7. Краткий чеклист реализации

(В ai_report реализовано см. разд. 8.)

- [ ] Клиент Confluence REST API (Bearer, методы: список страниц/пространств, тело страницы).
- [ ] Парсер Confluence Storage/HTML → структура `content` (секции/подсекции) + метаданные.
- [ ] Маппинг в единый формат KB (title, audience, scope, status, content, source).
- [ ] Обработка Draw.io/вложений по политике проекта.
- [ ] Сохранение в JSON и/или в БД KB.
- [ ] Подключение к существующему пайплайну загрузки KB в RAG.
- [ ] (Опционально) UI для выбора пространства/страниц и запуска выгрузки.
- [ ] (Опционально) обратная публикация KB → Confluence, если нужна двусторонняя синхронизация.

Документ подготовлен по отчётам и коду проекта steccom-rag-lk.

---

## 8. Реализация в ai_report (боевой проект)

В текущем репозитории интеграция Confluence с единой KB биллинга/спутниковых систем реализована так:

| Компонент | Путь | Назначение |
|-----------|------|------------|
| Confluence REST client | `kb_billing/rag/confluence_client.py` | Bearer-аутентификация, проверка подключения, список пространств, страницы пространства, тело страницы (body.storage). |
| Генератор KB из Confluence | `kb_billing/rag/confluence_kb_generator.py` | Парсинг Confluence Storage → `content[]`, маппинг в формат KB, сохранение в `kb_billing/confluence_docs/confluence_<space>.json`. |
| Загрузка в RAG | `kb_billing/rag/kb_loader.py` (метод `load_confluence_docs`) | Чтение JSON из `confluence_docs/`, эмбеддинги, загрузка в **ту же** коллекцию Qdrant (`kb_billing`). В payload: `type=confluence_doc`, `domain=satellite` Сектор спутниковых систем наполняется **структурой из Confluence** (страницы, секции), а не SQL-примерами. |
| Библиотекарь (UI) | `kb_billing/rag/streamlit_kb_expansion.py` | Вкладка Confluence: настройка URL/docs.steccom.ru, проверка подключения, синхронизация пространства, перезагрузка KB. |
| Тест подключения | `scripts/test_confluence_connection.py` | Проверка доступности Confluence (в т.ч. docs.steccom.ru) с ноутбука перед deploy. |

Переменные окружения: `CONFLUENCE_URL` (например `https://docs.steccom.ru`), `CONFLUENCE_TOKEN` (Personal Access Token). Токен не хранить в коде.
