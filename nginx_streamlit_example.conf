# Пример конфигурации nginx для проксирования Streamlit
# Разместите этот файл в /etc/nginx/sites-available/ или включите в основной конфиг
# 
# Использование:
# 1. Скопируйте конфигурацию в /etc/nginx/sites-available/streamlit_ai_report
# 2. Создайте симлинк: ln -s /etc/nginx/sites-available/streamlit_ai_report /etc/nginx/sites-enabled/
# 3. Проверьте конфигурацию: nginx -t
# 4. Перезагрузите nginx: systemctl reload nginx
#
# На машине vz2 (82.114.2.2) запустите Streamlit с:
# STREAMLIT_PROXY_MODE=proxy STREAMLIT_BASE_URL_PATH=/ai_report ./run_streamlit_oracle.sh

server {
    listen 7776;
    server_name stat.steccom.ru;

    # Логирование для отладки
    access_log /var/log/nginx/streamlit_ai_report_access.log;
    error_log /var/log/nginx/streamlit_ai_report_error.log debug;

    # Увеличиваем размер буферов для больших ответов
    client_max_body_size 50M;
    proxy_buffering off;
    proxy_request_buffering off;

    # Проксирование основного приложения Streamlit
    location /ai_report/ {
        # Убираем trailing slash для правильной работы
        rewrite ^/ai_report/(.*)$ /$1 break;
        rewrite ^/ai_report$ / break;
        
        proxy_pass http://82.114.2.2:8504;
        proxy_http_version 1.1;
        
        # Заголовки для проксирования
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket поддержка (критично для Streamlit!)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Таймауты для WebSocket
        proxy_read_timeout 86400;
        proxy_connect_timeout 86400;
        proxy_send_timeout 86400;
        
        # Отключаем кэширование для Streamlit
        proxy_cache_bypass $http_upgrade;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Проксирование статических файлов Streamlit
    location /ai_report/_static/ {
        proxy_pass http://82.114.2.2:8504/_static/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Кэширование статики
        expires 1d;
        add_header Cache-Control "public, immutable";
    }

    # Проксирование WebSocket соединений (критично!)
    location /ai_report/_stcore/stream {
        proxy_pass http://82.114.2.2:8504/_stcore/stream;
        proxy_http_version 1.1;
        
        # WebSocket заголовки
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Длинные таймауты для WebSocket
        proxy_read_timeout 86400;
        proxy_connect_timeout 86400;
        proxy_send_timeout 86400;
        
        # Отключаем буферизацию для WebSocket
        proxy_buffering off;
    }

    # Health check endpoint
    location /ai_report/health {
        proxy_pass http://82.114.2.2:8504/_stcore/health;
        access_log off;
    }

    # Корневой путь - редирект на /ai_report/
    location = /ai_report {
        return 301 /ai_report/;
    }
}



