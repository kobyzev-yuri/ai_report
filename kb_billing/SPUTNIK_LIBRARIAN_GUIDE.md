# Использование спутникового библиотекаря

Руководство по работе с вкладкой **«Спутниковый библиотекарь»** — интеграция документации Confluence (docs.steccom.ru) с единой базой знаний для ассистента по спутниковым системам.

---

## 1. Назначение

- Подключение к Confluence компании (docs.steccom.ru).
- Выгрузка страниц в единый формат KB и сохранение в `kb_billing/confluence_docs/`.
- Загрузка документов Confluence в ту же векторную коллекцию Qdrant (вместе с биллингом), домен `satellite`.
- Управление списком документов: обновление из Confluence, пометка устаревших.
- Проверка релевантности: вопросы по тематике документов и оценка качества поиска.

---

## 2. Подготовка

### Переменные окружения

В `config.env` (или в переменных окружения) должны быть заданы:

- **CONFLUENCE_URL** — базовый URL Confluence, например `https://docs.steccom.ru`.
- **CONFLUENCE_TOKEN** — Personal Access Token (Bearer) с правами на чтение страниц.

Токен создаётся в Confluence: профиль → Settings → Personal access tokens → Create. В коде не хранить.

### Проверка доступа

- На вкладке: ввести URL и токен (или использовать значения из config.env), нажать **«Проверить подключение к Confluence»**.
- С сервера (vz2): выполнить `./deploy/test_confluence_access.sh` (см. DEPLOY_CHECKLIST.md).

---

## 3. Синхронизация документов

### По ключу пространства (Space key)

- **Ключ пространства** — короткий идентификатор, не URL. Примеры: `DEMO`, `SPC`, для личного пространства пользователя — `~n.shiriaev` (тильда + логин).
- Укажите ключ, при необходимости ограничьте число страниц за один запуск, нажмите **«Синхронизировать пространство в KB»**.
- Результат сохраняется в `confluence_docs/confluence_<space_key>.json`. Для личных пространств часть инстансов Confluence может возвращать 404 по spaceKey — тогда используйте выгрузку по URL/ID страниц (ниже).

### По URL или ID страниц

- В блоке **«Конкретные страницы по URL или ID»** введите по одной строке: ссылки на страницы Confluence или только числовой Page ID.
- Пример URL: `https://docs.steccom.ru/pages/viewpage.action?pageId=123456`.
- Нажмите **«Синхронизировать выбранные страницы в KB»**. Результат пишется в `confluence_docs/confluence_custom_pages.json`.

---

## 4. Список документов в KB

В блоке **«Документы Confluence в KB»** отображаются:

- Все документы из `kb_billing/confluence_docs/*.json` (кроме служебных файлов).
- По каждому: заголовок, ссылка на Confluence, файл, page_id.
- Счётчики: всего документов и сколько актуальных / устаревших.

Раскройте **«Показать список документов: обновить / пометить устаревшим»** для действий по каждому документу.

---

## 5. Обновление и пометка устаревших

### Обновить из Confluence

- В списке документов нажмите **«Обновить из Confluence»** у нужной строки. Содержимое страницы заново загружается из Confluence и перезаписывается в соответствующем JSON.
- После обновления нажмите **«Перезагрузить KB в Qdrant»**, чтобы изменения попали в поиск.

### Пометить устаревшим

- Нажмите **«Пометить устаревшим»**. Page_id документа добавляется в файл `confluence_docs/outdated.txt`.
- При следующей загрузке KB в Qdrant документы из этого списка не попадают в векторную базу и не участвуют в поиске.
- Чтобы снова учитывать документ в поиске: нажмите **«Вернуть в актуальные»** и затем **«Перезагрузить KB в Qdrant»**.

---

## 6. Загрузка в векторную KB (Qdrant)

- После любой синхронизации или смены пометок нажмите **«Перезагрузить KB в Qdrant (все источники)»**.
- Подгружаются все источники KB (биллинг + Confluence). Документы из `outdated.txt` при загрузке Confluence пропускаются.
- Без перезагрузки новые или обновлённые документы в поиске не появятся.

---

## 7. Проверка релевантности

В блоке **«Проверка релевантности»**:

- Введите вопрос по тематике загруженных документов (например: что такое Z10MK4, инструкция Kingsat P8).
- Укажите, сколько документов показывать (1–15).
- Нажмите **«Найти в документах Confluence»**. Выполняется семантический поиск только по документам типа `confluence_doc` в Qdrant.
- В результатах: заголовок, оценка сходства (score), ссылка на страницу, фрагмент текста. По score и фрагменту можно оценить, насколько ответ релевантен вопросу.

---

## 8. Файлы и пути

| Назначение | Путь |
|------------|------|
| Документы Confluence (JSON) | `kb_billing/confluence_docs/*.json` |
| Список устаревших page_id | `kb_billing/confluence_docs/outdated.txt` |
| Клиент Confluence API | `kb_billing/rag/confluence_client.py` |
| Генератор KB из Confluence | `kb_billing/rag/confluence_kb_generator.py` |
| UI спутникового библиотекаря | `kb_billing/rag/streamlit_confluence_librarian.py` |
| Загрузка Confluence-документов в Qdrant | `kb_billing/rag/kb_loader.py` (метод `load_confluence_docs`) |

---

## 9. Тест доступа с сервера

Перед тестированием на сервере проверьте доступ к Confluence:

```bash
cd /usr/local/projects/ai_report
./deploy/test_confluence_access.sh
```

При успехе можно синхронизировать документы и проверять релевантность через веб-интерфейс (вкладка «Спутниковый библиотекарь»).
