# Краткое резюме: Методология KB для Oracle billing

## Ключевые принципы (из sql4A)

### 1. Три типа данных в KB

1. **DDL** - структура таблиц и представлений Oracle
2. **Documentation** - бизнес-логика, правила, связи
3. **Q/A Examples** - примеры вопросов финансистов → SQL

### 2. Структура метаданных

Каждый элемент в KB имеет:
- `content` - текст (DDL, документация, или "Q: ... A: ...")
- `content_type` - тип: 'ddl', 'documentation', 'qa_example'
- `metadata` - JSON с дополнительной информацией:
  - Для Q/A: `category`, `complexity`, `business_entity`, `table_names`
  - Для DDL: `table_name`, `schema`, `database`
  - Для документации: `table_name`, `category`, `business_domain`

### 3. Процесс подготовки KB

```
1. Извлечение DDL из Oracle
   ↓
2. Подготовка документации из JSON файлов kb_billing
   ↓
3. Подготовка Q/A примеров (из training_data + реальные запросы)
   ↓
4. Загрузка в векторную БД (независимо от типа)
   ↓
5. Генерация эмбеддингов (модель для русского языка)
   ↓
6. Создание индексов (векторный + по метаданным)
```

### 4. Метрики тестирования

- **Accuracy** - точность SQL генерации (> 0.8)
- **Top-k Hit Rate** - точность ретривера (> 0.6 для top-1)
- **MRR** - средняя обратная позиция (> 0.7)

### 5. Наборы тестов

- **Seen** - исходные вопросы из KB (Accuracy > 0.9)
- **Paraphrases** - перефразы вопросов (Accuracy > 0.7)
- **Unseen** - новые вопросы (Accuracy > 0.6)

### 6. Критерии корректности SQL

1. Синтаксическая валидность (для Oracle)
2. Execution Equivalence (результаты совпадают)
3. Оптимизация (опционально, через EXPLAIN PLAN)

---

## Адаптация для Oracle billing

### Особенности Oracle SQL

- Даты: `TO_DATE('202510', 'YYYYMM')`
- Ограничения: `ROWNUM <= 10` вместо `LIMIT 10`
- Типы: `VARCHAR2`, `NUMBER`
- Представления активно используются

### Категории запросов для финансистов

- **Превышение трафика** - расчет и анализ превышений
- **Финансовые отчеты** - себестоимость, доходы
- **Сервисы** - поиск и сверка услуг
- **Клиенты** - информация о клиентах
- **Финансовые алерты** - выявление проблем

### Бизнес-сущности

- `overage` - превышение трафика
- `services` - сервисы Iridium
- `customers` - клиенты
- `billing` - биллинг
- `reports` - финансовые отчеты

---

## Итеративный процесс улучшения

```
Загрузка KB → Тестирование → Анализ метрик → Рекомендации 
    ↑                                                    ↓
    └────────── Добавление данных ←─────────────────────┘
```

---

## Практические шаги

1. **Подготовить данные** из kb_billing (DDL, документация, Q/A)
2. **Загрузить в векторную БД** (любую: pgvector/Qdrant/Chroma)
3. **Сгенерировать эмбеддинги** (модель для русского языка)
4. **Протестировать** (benchmark на seen + paraphrases)
5. **Проанализировать** метрики и ошибки
6. **Улучшить** на основе рекомендаций
7. **Повторить** тестирование

---

## Преимущества методологии sql4A

1. ✅ **Проверенная методология** - уже работает
2. ✅ **Независимость от векторной БД** - можно использовать любую
3. ✅ **Структурированные метаданные** - для фильтрации и категоризации
4. ✅ **Регулярное тестирование** - объективные метрики качества
5. ✅ **Итеративное улучшение** - на основе данных

Подробности: см. `KB_METHODOLOGY.md`

