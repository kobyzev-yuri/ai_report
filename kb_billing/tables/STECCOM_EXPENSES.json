{
  "table_name": "STECCOM_EXPENSES",
  "schema": "billing",
  "description": "Таблица расходов STECCOM - биллинг данные Iridium M2M из инвойсов STECCOM. Содержит информацию о планах тарифов, fees (активация, авансы, кредиты), и расходах по каждому контракту.",
  "database": "Oracle (production) / PostgreSQL (testing)",
  "ddl": "CREATE TABLE STECCOM_EXPENSES (\n    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\n    INVOICE_DATE DATE,\n    COMPANY_NAME VARCHAR2(200),\n    COMPANY_NUMBER NUMBER,\n    SETTLING_PERIOD NUMBER,\n    FEE_TYPE VARCHAR2(100),\n    CONTRACT_ID VARCHAR2(50),\n    IMSI_ISDNA VARCHAR2(50),\n    ICC_ID_IMEI VARCHAR2(50),\n    ACTIVATION_DATE DATE,\n    TRANSACTION_DATE DATE,\n    SERVICE VARCHAR2(100),\n    RATE_TYPE VARCHAR2(100),\n    PLAN_DISCOUNT VARCHAR2(100),\n    DESCRIPTION VARCHAR2(500),\n    PRORATED_DAYS NUMBER,\n    AMOUNT NUMBER(10,2),\n    GROUP_NAME VARCHAR2(100),\n    SOURCE_FILE VARCHAR2(200),\n    LOAD_DATE DATE DEFAULT SYSDATE,\n    CREATED_BY VARCHAR2(50) DEFAULT USER\n);",
  "key_columns": {
    "CONTRACT_ID": "ID контракта - связь с биллингом (SERVICES.LOGIN). Формат: SUB-XXXXX",
    "ICC_ID_IMEI": "IMEI номер устройства. Связь с SPNET_TRAFFIC.IMEI",
    "INVOICE_DATE": "Дата инвойса. Используется для определения BILL_MONTH (формат: YYYYMM)",
    "ACTIVATION_DATE": "Дата активации сервиса. Минимальная дата для периода используется в отчетах",
    "DESCRIPTION": "Описание расхода: 'Activation Fee', 'Advance Charge', 'Credit', 'Credited', 'Prorated' и т.д.",
    "AMOUNT": "Сумма расходов (USD)",
    "RATE_TYPE": "Тип тарифа: может содержать 'Suspend' для приостановленных планов",
    "PLAN_DISCOUNT": "Название тарифного плана из STECCOM (может отличаться от PLAN_NAME в SPNET_TRAFFIC)",
    "SERVICE": "Тип сервиса. NULL или 'BROADBAND' - фильтруется в запросах (только Iridium M2M)"
  },
  "business_rules": [
    "BILL_MONTH определяется из INVOICE_DATE: TO_CHAR(INVOICE_DATE, 'YYYYMM')",
    "ВАЖНО: Для Иридиум финансовый период 'кривой' - с 2 числа по 1 число следующего месяца. Файл STECCOMLLCRussiaSBD.AccessFees.YYYYMMDD.csv содержит счета за период с 2 числа предыдущего месяца по 1 число месяца из даты в имени файла",
    "Пример: файл STECCOMLLCRussiaSBD.AccessFees.20250702.csv (дата 02.07.2025) содержит счета за период с 2 июня по 1 июля, BILL_MONTH = 202506 (июнь)",
    "Для Iridium M2M: SERVICE IS NULL OR UPPER(TRIM(SERVICE)) != 'BROADBAND'",
    "Fees группируются по типам: Activation Fee, Advance Charge, Credit, Credited, Prorated",
    "PLAN_DISCOUNT разделяется на два типа: основной план (RATE_TYPE не содержит 'Suspend') и suspended план (RATE_TYPE содержит 'Suspend')",
    "Advance Charge за месяц X отображается в отчете за месяц X+1 как 'fee_advance_charge_previous_month'",
    "SOURCE_FILE содержит имя CSV файла, из которого загружены данные (формат: STECCOMLLCRussiaSBD.AccessFees.YYYYMMDD.csv)"
  ],
  "relationships": [
    {
      "table": "SPNET_TRAFFIC",
      "type": "LEFT JOIN",
      "on": "STECCOM_EXPENSES.CONTRACT_ID = SPNET_TRAFFIC.CONTRACT_ID AND STECCOM_EXPENSES.ICC_ID_IMEI = SPNET_TRAFFIC.IMEI"
    },
    {
      "table": "IRIDIUM_SERVICES_INFO",
      "type": "LEFT JOIN",
      "on": "STECCOM_EXPENSES.CONTRACT_ID = IRIDIUM_SERVICES_INFO.CONTRACT_ID"
    }
  ],
  "indexes": [
    "IDX_STECCOM_IMEI ON STECCOM_EXPENSES(ICC_ID_IMEI)",
    "IDX_STECCOM_CONTRACT ON STECCOM_EXPENSES(CONTRACT_ID)",
    "IDX_STECCOM_INVOICE_DATE ON STECCOM_EXPENSES(INVOICE_DATE)",
    "IDX_STECCOM_SERVICE ON STECCOM_EXPENSES(SERVICE)",
    "IDX_STECCOM_DESCRIPTION ON STECCOM_EXPENSES(DESCRIPTION)"
  ],
  "usage_notes": [
    "Используется для получения информации о планах тарифов (STECCOM_PLAN_NAME_MONTHLY, STECCOM_PLAN_NAME_SUSPENDED)",
    "Fees агрегируются по типам для каждого периода (BILL_MONTH, CONTRACT_ID, IMEI)",
    "Advance Charge за предыдущий месяц включается в V_CONSOLIDATED_REPORT_WITH_BILLING",
    "Файлы загружаются из CSV формата: STECCOMLLCRussiaSBD.AccessFees.YYYYMMDD.csv, где YYYYMMDD - дата окончания периода",
    "Для расчета себестоимости нужно связать доходы (из ANALYTICS.MONEY или BM_INVOICE_ITEM.MONEY) с затратами (STECCOM_EXPENSES.AMOUNT)",
    "При сопоставлении периодов: BILL_MONTH (STECCOM) нужно сопоставлять с PERIOD_ID (ANALYTICS/BM_INVOICE_ITEM) через BM_PERIODS, учитывая что период Иридиум с 2 числа по 1 число следующего месяца"
  ]
}

