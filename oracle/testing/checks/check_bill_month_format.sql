SELECT se.SOURCE_FILE, se.ICC_ID_IMEI AS IMEI, se.CONTRACT_ID, CASE WHEN REGEXP_LIKE(se.SOURCE_FILE, '\.([0-9]{8})\.csv$') THEN CASE WHEN MOD(TO_NUMBER(REGEXP_SUBSTR(se.SOURCE_FILE, '\.([0-9]{8})\.csv$', 1, 1, NULL, 1)) / 100, 100) = 1 THEN TO_CHAR((TO_NUMBER(REGEXP_SUBSTR(se.SOURCE_FILE, '\.([0-9]{8})\.csv$', 1, 1, NULL, 1)) / 10000 - 1) * 100 + 12) ELSE TO_CHAR(TO_NUMBER(REGEXP_SUBSTR(se.SOURCE_FILE, '\.([0-9]{8})\.csv$', 1, 1, NULL, 1)) / 100 - 1) END ELSE CASE WHEN EXTRACT(MONTH FROM se.INVOICE_DATE) = 1 THEN TO_CHAR(EXTRACT(YEAR FROM se.INVOICE_DATE) - 1) || '12' ELSE TO_CHAR(EXTRACT(YEAR FROM se.INVOICE_DATE)) || LPAD(TO_CHAR(EXTRACT(MONTH FROM se.INVOICE_DATE) - 1), 2, '0') END END AS calculated_bill_month FROM STECCOM_EXPENSES se WHERE se.ICC_ID_IMEI = '300234069907470' AND se.SOURCE_FILE LIKE '%20251002%' GROUP BY se.SOURCE_FILE, se.ICC_ID_IMEI, se.CONTRACT_ID, CASE WHEN REGEXP_LIKE(se.SOURCE_FILE, '\.([0-9]{8})\.csv$') THEN CASE WHEN MOD(TO_NUMBER(REGEXP_SUBSTR(se.SOURCE_FILE, '\.([0-9]{8})\.csv$', 1, 1, NULL, 1)) / 100, 100) = 1 THEN TO_CHAR((TO_NUMBER(REGEXP_SUBSTR(se.SOURCE_FILE, '\.([0-9]{8})\.csv$', 1, 1, NULL, 1)) / 10000 - 1) * 100 + 12) ELSE TO_CHAR(TO_NUMBER(REGEXP_SUBSTR(se.SOURCE_FILE, '\.([0-9]{8})\.csv$', 1, 1, NULL, 1)) / 100 - 1) END ELSE CASE WHEN EXTRACT(MONTH FROM se.INVOICE_DATE) = 1 THEN TO_CHAR(EXTRACT(YEAR FROM se.INVOICE_DATE) - 1) || '12' ELSE TO_CHAR(EXTRACT(YEAR FROM se.INVOICE_DATE)) || LPAD(TO_CHAR(EXTRACT(MONTH FROM se.INVOICE_DATE) - 1), 2, '0') END END;

