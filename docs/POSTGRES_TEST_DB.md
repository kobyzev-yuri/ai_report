# PostgreSQL Тестовая База для Отладки

## Конфигурация

**База данных:** `billing`  
**Хост:** `localhost:5432`  
**Пользователь:** `postgres`  
**Пароль:** `1234`

Аналог Oracle: `billing7/billing@bm7`

## Быстрый старт

### 1. Подключение к базе
```bash
PGPASSWORD=1234 psql -h localhost -p 5432 -U postgres -d billing
```

### 2. Проверка таблиц
```sql
\dt
-- Таблицы: SPNET_TRAFFIC, STECCOM_EXPENSES, TARIFF_PLANS, LOAD_LOGS
```

### 3. Просмотр представлений
```sql
\dv
-- Представления: V_SPNET_OVERAGE_ANALYSIS, V_CONSOLIDATED_OVERAGE_REPORT
```

## Загруженные данные

- **SPNET_TRAFFIC**: 12,969 записей (3,016 уникальных IMEI)
- **STECCOM_EXPENSES**: 35,696 записей (4,301 уникальных IMEI)  
- **TARIFF_PLANS**: 2 тарифа (SBD-1, SBD-10)

## Полезные запросы

### Анализ превышения по IMEI
```sql
SELECT 
    IMEI,
    CONTRACT_ID,
    BILL_MONTH,
    PLAN_NAME,
    TOTAL_USAGE_KB,
    CALCULATED_OVERAGE_CHARGE,
    SPNET_TOTAL_AMOUNT
FROM V_SPNET_OVERAGE_ANALYSIS
WHERE CALCULATED_OVERAGE_CHARGE > 0
ORDER BY CALCULATED_OVERAGE_CHARGE DESC
LIMIT 10;
```

### Сводный отчет с STECCOM данными
```sql
SELECT 
    IMEI,
    CONTRACT_ID,
    BILL_MONTH,
    TOTAL_USAGE_KB,
    CALCULATED_OVERAGE AS overage_charge,
    ADVANCE_CHARGE AS monthly_fee,
    STECCOM_TOTAL_AMOUNT
FROM V_CONSOLIDATED_OVERAGE_REPORT
WHERE STECCOM_TOTAL_AMOUNT IS NOT NULL
  AND CALCULATED_OVERAGE > 0
ORDER BY CALCULATED_OVERAGE DESC
LIMIT 10;
```

### Тест функции расчета превышения
```sql
-- Пример: 35 KB на тарифе SBD-10
SELECT calculate_overage('SBD Tiered 1250 10K', 35000);
-- Результат: 6.50 USD
```

### Статистика по тарифным планам
```sql
SELECT 
    PLAN_NAME,
    COUNT(*) AS devices,
    SUM(TOTAL_USAGE_KB) AS total_usage_kb,
    SUM(CALCULATED_OVERAGE_CHARGE) AS total_overage
FROM V_SPNET_OVERAGE_ANALYSIS
GROUP BY PLAN_NAME;
```

## Python работа с базой

```python
import psycopg2

# Подключение
conn = psycopg2.connect(
    dbname='billing',
    user='postgres',
    password='1234',
    host='localhost',
    port=5432
)

# Запрос
cursor = conn.cursor()
cursor.execute("""
    SELECT IMEI, CALCULATED_OVERAGE_CHARGE 
    FROM V_SPNET_OVERAGE_ANALYSIS 
    WHERE CALCULATED_OVERAGE_CHARGE > 100
    LIMIT 5
""")
results = cursor.fetchall()
for row in results:
    print(f"IMEI: {row[0]}, Overage: ${row[1]}")

cursor.close()
conn.close()
```

## Расчет превышения (Python)

```python
from calculate_overage import calculate_overage

# Простой расчет
charge = calculate_overage('SBD Tiered 1250 10K', 35000)
print(f"Стоимость превышения: ${charge}")  # 6.5

# Детальный расчет
result = calculate_overage('SBD Tiered 1250 10K', 35000, detailed=True)
print(result)
```

## Формат BILL_MONTH

**SPNet использует формат:** `MMYYYY` (месяц * 10000 + год)
- 22025 = февраль 2025 (202502)
- 92025 = сентябрь 2025 (202509)
- 102025 = октябрь 2025 (202510)

**Конвертация в YYYYMM:**
```sql
LPAD(CAST(BILL_MONTH % 10000 AS TEXT), 4, '0') || 
LPAD(CAST(BILL_MONTH / 10000 AS TEXT), 2, '0')
```

## Отличия от Oracle

### Типы данных
| Oracle | PostgreSQL |
|--------|-----------|
| NUMBER | NUMERIC |
| VARCHAR2 | VARCHAR |
| DATE | DATE / TIMESTAMP |
| CLOB | TEXT |

### Автоинкремент
| Oracle | PostgreSQL |
|--------|-----------|
| `NUMBER GENERATED BY DEFAULT AS IDENTITY` | `SERIAL` |

### Функции
| Oracle | PostgreSQL |
|--------|-----------|
| `NVL()` | `COALESCE()` |
| `TO_CHAR()` | `TO_CHAR()` (одинаково) |
| `SYSDATE` | `CURRENT_TIMESTAMP` |

### Операторы
| Oracle | PostgreSQL |
|--------|-----------|
| `||` (конкатенация) | `||` или `CONCAT()` |
| `%` (по умолчанию нет) | `%` (модуло) |

## Файлы проекта

- `setup_postgres.sql` - схема базы данных
- `load_data_postgres.py` - загрузчик CSV данных
- `calculate_overage.py` - модуль расчета превышения
- `create_tariff_plans.sql` - Oracle версия (для продакшена)

## Пересоздание базы

```bash
# 1. Пересоздать схему
PGPASSWORD=1234 psql -h localhost -p 5432 -U postgres -d billing -f setup_postgres.sql

# 2. Загрузить данные
python3 load_data_postgres.py
```

## Следующие шаги

1. Отладить запросы в PostgreSQL
2. Адаптировать для Oracle (если нужны изменения)
3. Добавить недостающие тарифные планы
4. Создать финальные отчеты


