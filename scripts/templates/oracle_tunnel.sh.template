#!/bin/bash
# ============================================================================
# SSH —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Oracle —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ vz2
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./oracle_tunnel.sh [start|stop|status|restart]
# ============================================================================

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
# –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
SSH_HOST="your.ssh.server.com"
SSH_PORT="22"
SSH_USER="your_ssh_user"
ORACLE_HOST="oracle.server.local"
ORACLE_PORT="1521"
LOCAL_PORT="15210"  # –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –µ—Å–ª–∏ –∑–∞–Ω—è—Ç)
PID_FILE="/tmp/oracle_tunnel.pid"
LOG_FILE="/tmp/oracle_tunnel.log"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
ACTION="${1:-start}"

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç—É–Ω–Ω–µ–ª—è
check_tunnel() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p "$PID" > /dev/null 2>&1; then
            return 0  # –¢—É–Ω–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç
        else
            rm -f "$PID_FILE"
            return 1  # –¢—É–Ω–Ω–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        fi
    else
        return 1  # –§–∞–π–ª PID –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    fi
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —Ç—É–Ω–Ω–µ–ª—è
start_tunnel() {
    if check_tunnel; then
        echo "‚ö†Ô∏è  –¢—É–Ω–Ω–µ–ª—å —É–∂–µ –∑–∞–ø—É—â–µ–Ω (PID: $(cat $PID_FILE))"
        echo "   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ './oracle_tunnel.sh stop' –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
        return 1
    fi

    echo "============================================================================"
    echo "–ó–∞–ø—É—Å–∫ SSH —Ç—É–Ω–Ω–µ–ª—è –¥–ª—è Oracle"
    echo "============================================================================"
    echo "–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç:  localhost:$LOCAL_PORT"
    echo "SSH —Å–µ—Ä–≤–µ—Ä:      $SSH_USER@$SSH_HOST:$SSH_PORT"
    echo "Oracle —Å–µ—Ä–≤–µ—Ä:  $ORACLE_HOST:$ORACLE_PORT"
    echo ""

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ SSH —Å–µ—Ä–≤–µ—Ä–∞
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ SSH —Å–µ—Ä–≤–µ—Ä–∞..."
    if ! ssh -p "$SSH_PORT" -o ConnectTimeout=5 -o BatchMode=yes "$SSH_USER@$SSH_HOST" exit 2>/dev/null; then
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ SSH —Å–µ—Ä–≤–µ—Ä—É $SSH_USER@$SSH_HOST:$SSH_PORT"
        echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞"
        return 1
    fi
    echo "‚úÖ SSH —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
    if lsof -Pi :$LOCAL_PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  –ü–æ—Ä—Ç $LOCAL_PORT —É–∂–µ –∑–∞–Ω—è—Ç"
        echo "   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç –∏–ª–∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π"
        return 1
    fi

    # –ó–∞–ø—É—Å–∫ —Ç—É–Ω–Ω–µ–ª—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
    echo "üöÄ –ó–∞–ø—É—Å–∫ —Ç—É–Ω–Ω–µ–ª—è..."
    ssh -f -N -L "$LOCAL_PORT:$ORACLE_HOST:$ORACLE_PORT" \
        -p "$SSH_PORT" \
        -o ServerAliveInterval=60 \
        -o ServerAliveCountMax=3 \
        -o ExitOnForwardFailure=yes \
        "$SSH_USER@$SSH_HOST" \
        > "$LOG_FILE" 2>&1

    sleep 1

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞
    SSH_PID=$(pgrep -f "ssh.*-L $LOCAL_PORT:$ORACLE_HOST:$ORACLE_PORT")
    if [ -n "$SSH_PID" ]; then
        echo "$SSH_PID" > "$PID_FILE"
        echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω (PID: $SSH_PID)"
        echo ""
        echo "üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
        echo "   –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Oracle —á–µ—Ä–µ–∑ —Ç—É–Ω–Ω–µ–ª—å:"
        echo "   sqlplus your_user/your_password@localhost:$LOCAL_PORT/your_service"
        echo ""
        echo "   –ò–ª–∏ –≤ Python:"
        echo "   ORACLE_HOST=localhost"
        echo "   ORACLE_PORT=$LOCAL_PORT"
        echo ""
        echo "üìù –õ–æ–≥–∏: $LOG_FILE"
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ./oracle_tunnel.sh stop"
        return 0
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç—É–Ω–Ω–µ–ª—å"
        echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: $LOG_FILE"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—É–Ω–Ω–µ–ª—è
stop_tunnel() {
    if ! check_tunnel; then
        echo "‚ö†Ô∏è  –¢—É–Ω–Ω–µ–ª—å –Ω–µ –∑–∞–ø—É—â–µ–Ω"
        return 1
    fi

    PID=$(cat "$PID_FILE")
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—É–Ω–Ω–µ–ª—è (PID: $PID)..."
    
    kill "$PID" 2>/dev/null
    sleep 1
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if ps -p "$PID" > /dev/null 2>&1; then
        echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ..."
        kill -9 "$PID" 2>/dev/null
        sleep 1
    fi
    
    rm -f "$PID_FILE"
    
    if ! ps -p "$PID" > /dev/null 2>&1; then
        echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        return 0
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—É–Ω–Ω–µ–ª—å"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
status_tunnel() {
    if check_tunnel; then
        PID=$(cat "$PID_FILE")
        echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç (PID: $PID)"
        echo "   –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç: localhost:$LOCAL_PORT"
        echo "   Oracle —Å–µ—Ä–≤–µ—Ä: $ORACLE_HOST:$ORACLE_PORT —á–µ—Ä–µ–∑ $SSH_USER@$SSH_HOST:$SSH_PORT"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
        if lsof -Pi :$LOCAL_PORT -sTCP:LISTEN >/dev/null 2>&1; then
            echo "   –ü–æ—Ä—Ç $LOCAL_PORT —Å–ª—É—à–∞–µ—Ç—Å—è"
        else
            echo "   ‚ö†Ô∏è  –ü–æ—Ä—Ç $LOCAL_PORT –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è"
        fi
        return 0
    else
        echo "‚ùå –¢—É–Ω–Ω–µ–ª—å –Ω–µ –∑–∞–ø—É—â–µ–Ω"
        return 1
    fi
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
case "$ACTION" in
    start)
        start_tunnel
        ;;
    stop)
        stop_tunnel
        ;;
    status)
        status_tunnel
        ;;
    restart)
        stop_tunnel
        sleep 1
        start_tunnel
        ;;
    *)
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [start|stop|status|restart]"
        echo ""
        echo "–î–µ–π—Å—Ç–≤–∏—è:"
        echo "  start   - –ó–∞–ø—É—Å—Ç–∏—Ç—å SSH —Ç—É–Ω–Ω–µ–ª—å"
        echo "  stop    - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SSH —Ç—É–Ω–Ω–µ–ª—å"
        echo "  status  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç—É–Ω–Ω–µ–ª—è"
        echo "  restart - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç—É–Ω–Ω–µ–ª—å"
        echo ""
        echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∏:"
        echo "  –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç:  $LOCAL_PORT"
        echo "  SSH —Å–µ—Ä–≤–µ—Ä:      $SSH_USER@$SSH_HOST:$SSH_PORT"
        echo "  Oracle —Å–µ—Ä–≤–µ—Ä:   $ORACLE_HOST:$ORACLE_PORT"
        exit 1
        ;;
esac

exit $?

