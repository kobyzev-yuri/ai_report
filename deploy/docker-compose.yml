version: '3.7'

services:
  # Qdrant - векторная БД для KB
  qdrant:
    image: qdrant/qdrant:latest
    container_name: ai_report_qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334

  # Streamlit приложение
  streamlit:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: ai_report_streamlit
    restart: unless-stopped
    ports:
      - "8504:8504"
    volumes:
      - .:/app
      - streamlit_data:/app/data
      - streamlit_cache:/root/.cache
    environment:
      - ORACLE_USER=${ORACLE_USER}
      - ORACLE_PASSWORD=${ORACLE_PASSWORD}
      - ORACLE_HOST=${ORACLE_HOST}
      - ORACLE_PORT=${ORACLE_PORT:-1521}
      - ORACLE_SID=${ORACLE_SID}
      - ORACLE_SERVICE=${ORACLE_SERVICE:-${ORACLE_SID}}
      - ORACLE_SCHEMA=${ORACLE_SCHEMA:-billing}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-kb_billing}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-intfloat/multilingual-e5-base}
      - STREAMLIT_SERVER_PORT=8504
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_BASE_URL_PATH=${BASE_URL_PATH:-/ai_report}
      - STREAMLIT_SERVER_ENABLE_CORS=false
      - STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION=false
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - qdrant
    command: >
      sh -c "
        echo 'Ожидание готовности Qdrant...' &&
        sleep 10 &&
        echo 'Инициализация KB в Qdrant...' &&
        python3 kb_billing/rag/init_kb.py --host qdrant --port 6333 --collection kb_billing || echo 'KB уже инициализирована или ошибка' &&
        echo 'Запуск Streamlit...' &&
        streamlit run streamlit_report_oracle_backup.py
          --server.port=$${STREAMLIT_SERVER_PORT}
          --server.headless=$${STREAMLIT_SERVER_HEADLESS}
          --server.baseUrlPath=$${STREAMLIT_SERVER_BASE_URL_PATH}
          --server.enableCORS=$${STREAMLIT_SERVER_ENABLE_CORS}
          --server.enableXsrfProtection=$${STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION}
      "

volumes:
  qdrant_storage:
  streamlit_data:
  streamlit_cache:
