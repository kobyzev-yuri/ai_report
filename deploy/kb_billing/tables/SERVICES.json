{
  "table_name": "SERVICES",
  "schema": "billing",
  "description": "Основная таблица услуг биллинга. Содержит информацию о всех услугах, включая Iridium M2M сервисы (TYPE_ID = 9002, 9005, 9008, 9013, 9014). Связывает услуги с клиентами (CUSTOMER_ID), аккаунтами (ACCOUNT_ID) и тарифами (TARIFF_ID).",
  "database": "Oracle (production)",
  "key_columns": {
    "SERVICE_ID": "Уникальный идентификатор услуги (PRIMARY KEY)",
    "LOGIN": "Логин услуги. Для Iridium SBD (TYPE_ID=9002): формат SUB-XXXXX (CONTRACT_ID). Для suspend (TYPE_ID=9008): IMEI (VSAT)",
    "VSAT": "IMEI устройства (для Iridium сервисов). Связь с SPNET_TRAFFIC.IMEI",
    "TYPE_ID": "Тип услуги из BM_TYPE: 9002=SBD (тарификация по трафику), 9005=мониторинг, 9008=suspend (приостановление), 9013=блокировка мониторинга, 9014=сообщения, 14=SSG (групповой сервис с подписками - самый сложный тип тарификации), 30=доступ к Личному кабинету (веб-сервер личного кабинета, позволяет абоненту входить по логину и паролю услуги)",
    "CARD_ID": "ID карты из CARDS. При активации карты radiusd тарификатор создает группу сервисов (SSG, VOIP, TYPE_ID=30), которые ссылаются на card_id",
    "note_type_30": "Для услуг TYPE_ID=30 (личный кабинет): расширенные атрибуты (права доступа, флаги) хранятся в SERVICES_EXT. Связь через SERVICES_EXT.SERVICE_ID = SERVICES.SERVICE_ID. DICT_ID определяет тип атрибута (например, DICT_ID=283 для allow_suspend - право на приостановку/возобновление услуги)",
    "TARIFF_ID": "ID тарифа из BM_TARIFF. Связь с нашими тарифными планами для клиентов",
    "CUSTOMER_ID": "ID клиента из CUSTOMERS",
    "ACCOUNT_ID": "ID аккаунта из ACCOUNTS",
    "STATUS": "Статус услуги: 10 = активный, -10 = приостановленный",
    "ACTUAL_STATUS": "Актуальный статус услуги",
    "START_DATE": "Дата создания услуги в системе. ВАЖНО: Если NULL - услуга тестовая и не попадет в счета-фактуры. По договору услуга начинается с OPEN_DATE, а не с START_DATE",
    "STOP_DATE": "Дата завершения договора (stop_date). Используется для расчета абонплаты: не считаем дни после STOP_DATE при расчете активных/неактивных дней. Если приостановление услуги не предусмотрено, то обычно STOP_DATE=CLOSE_DATE",
    "CLOSE_DATE": "Дата приостановки услуги (close_date). ВАЖНО: Есть тонкости в использовании. Если приостановление услуги не предусмотрено, то обычно STOP_DATE=CLOSE_DATE",
    "CREATE_DATE": "Дата создания услуги",
    "OPEN_DATE": "Дата начала предоставления услуги по договору (open_date). ВАЖНО: Если NULL - услуга тестовая и не попадет в счета-фактуры. По договору услуга начинается с OPEN_DATE, а не с START_DATE. Используется для расчета абонплаты: не считаем дни до OPEN_DATE при расчете активных/неактивных дней",
    "BLANK": "Номер заказа/приложения к договору (бланк)",
    "DESCRIPTION": "Описание услуги",
    "BALANCE_IRIDIUM": "Баланс Iridium (по умолчанию 0)",
    "STATUS_IRIDIUM": "Статус Iridium"
  },
  "business_rules": [
    "Для Iridium SBD (TYPE_ID=9002): LOGIN = SUB-XXXXX (CONTRACT_ID), VSAT = IMEI. ВАЖНО: Это ГЛАВНАЯ услуга, от которой зависят остальные (9008, 9005, 9013)",
    "Для мониторинга (TYPE_ID=9005): зависит от главной услуги 9002, но не для всех SBD есть мониторинг - только для тех, кто на услуге мониторинга. ВАЖНО: Мониторинг и SBD активны ОДНОВРЕМЕННО",
    "Для suspend (TYPE_ID=9008): LOGIN = IMEI (VSAT), связана с главной услугой 9002 по VSAT и ACCOUNT_ID. Зависит от 9002. ВАЖНО: Приостановка активна в ОСТАВШЕЕСЯ ВРЕМЯ (когда SBD не активна)",
    "Для блокировки (TYPE_ID=9013): блокировка мониторинга. ВАЖНО: Блокировка активна в ОСТАВШЕЕСЯ ВРЕМЯ (когда SBD не активна)",
    "Услуги 9002 и 9008 в противофазе: когда 9008 активна, 9002 приостановлена и наоборот",
    "Иерархия зависимостей и режимы работы:",
    "  - 9002 (SBD) - главная → 9005 (мониторинг) активен одновременно с SBD",
    "  - 9002 (SBD) - главная → 9008 (suspend) и 9013 (gsm_block) активны в оставшееся время (когда SBD не активна)",
    "Для SSG (TYPE_ID=14): SERVICE_ID - это групповой сервис, в котором есть подписки (SUBSCRIPTION_ID) для разных технических услуг по скорости. Подписки активируются в зависимости от условий (порогов) в тарифном плане. TYPE_ID=14 - самый сложный тип тарификации",
    "При активации предоплаченной карты (CARDS) radiusd тарификатор создает группу сервисов, которые ссылаются на card_id:",
    "  - SSG сервис (TYPE_ID=14) - групповой сервис с подписками",
    "  - VOIP сервис - услуга телефонии",
    "  - Доступ к Личному кабинету (TYPE_ID=30) - веб-сервер личного кабинета",
    "Тарифы сервисов при активации карты связаны с batches (BATCHES) через тарифный план",
    "TARIFF_ID связывается с BM_TARIFF.TARIFF_ID для получения информации о тарифе клиента",
    "Связь с тарифами по периодам через BM_SERVICE_TARIFF (DATE_BEG, DATE_END)",
    "STATUS = 10 означает активную услугу, STATUS = -10 означает приостановленную",
    "Для активных услуг: STATUS = 10 AND LOGIN NOT LIKE '%-clone-%'",
    "ПРИМЕЧАНИЕ: Тестовые услуги и услуги, которые не попадут в счета-фактуры, можно определить по NULL в START_DATE или OPEN_DATE. Фильтровать их не обязательно - финансисты работают со всеми данными",
    "ВАЖНО для расчета абонплаты на основе активных/неактивных дней:",
    "  - START_DATE: дата создания услуги в системе (не используется для расчета абонплаты)",
    "  - OPEN_DATE (open_date): дата начала предоставления услуги по договору - не считаем дни до OPEN_DATE при расчете активных/неактивных дней",
    "  - CLOSE_DATE (close_date): дата приостановки услуги (есть тонкости в использовании)",
    "  - STOP_DATE (stop_date): дата завершения договора - не считаем дни после STOP_DATE при расчете активных/неактивных дней",
    "  - Если приостановление услуги не предусмотрено, то играют роль OPEN_DATE и STOP_DATE (обычно в этом случае STOP_DATE=CLOSE_DATE)",
    "  - Включенный в абонплату трафик также рассчитывается пропорционально активным дням",
    "  - Пример расчета: если услуга активирована 10 января, SUSPEND 12 января → 2 активных дня (10, 11), 29 неактивных",
    "    * Если OPEN_DATE = 8 января: активных дней на 7 меньше (не считаем дни до 8 января, т.е. дни 1-7 не учитываются)",
    "    * Если STOP_DATE = 25 января: неактивных дней на 6 меньше (не считаем дни после 25 января, т.е. дни 26-31 не учитываются)",
    "  - Логика расчета на основе BM_ACTION_LOG:",
    "    * OLD_VALUE='SUSPEND', NEW_VALUE='UNSUSPEND' (активация) → весь день, где MOMENT, считается АКТИВНЫМ (приоритет активных дней)",
    "    * OLD_VALUE='UNSUSPEND', NEW_VALUE='SUSPEND' (приостановка) → день может быть неактивным, но следующий ПОЛНЫЙ день может быть неактивным, если в нем не было активации после MOMENT"
  ],
  "relationships": [
    {
      "table": "SERVICES_EXT",
      "type": "LEFT JOIN",
      "on": "SERVICES.SERVICE_ID = SERVICES_EXT.SERVICE_ID",
      "note": "Дополнительные параметры услуги (расширенные настройки, флаги)"
    },
    {
      "table": "BM_TARIFF",
      "type": "LEFT JOIN",
      "on": "SERVICES.TARIFF_ID = BM_TARIFF.TARIFF_ID"
    },
    {
      "table": "BM_SERVICE_TARIFF",
      "type": "LEFT JOIN",
      "on": "SERVICES.SERVICE_ID = BM_SERVICE_TARIFF.SERVICE_ID"
    },
    {
      "table": "CUSTOMERS",
      "type": "JOIN",
      "on": "SERVICES.CUSTOMER_ID = CUSTOMERS.CUSTOMER_ID"
    },
    {
      "table": "ACCOUNTS",
      "type": "JOIN",
      "on": "SERVICES.ACCOUNT_ID = ACCOUNTS.ACCOUNT_ID"
    },
    {
      "table": "BM_TYPE",
      "type": "LEFT JOIN",
      "on": "SERVICES.TYPE_ID = BM_TYPE.TYPE_ID"
    },
    {
      "table": "SPNET_TRAFFIC",
      "type": "LEFT JOIN",
      "on": "SERVICES.LOGIN = SPNET_TRAFFIC.CONTRACT_ID AND SERVICES.VSAT = SPNET_TRAFFIC.IMEI"
    },
    {
      "table": "CARDS",
      "type": "LEFT JOIN",
      "on": "SERVICES.CARD_ID = CARDS.CARD_ID",
      "note": "Предоплаченная карта. При активации карты radiusd тарификатор создает группу сервисов (SSG, VOIP, TYPE_ID=30), которые ссылаются на card_id"
    }
  ],
  "usage_notes": [
    "Используется для получения информации об услугах клиентов",
    "TARIFF_ID указывает на тариф клиента (наши тарифы), а не тарифы Иридиум",
    "Для расчета доходов нужно использовать BM_TARIFFEL с ценами (MONEY)",
    "Связь с тарифами по периодам через BM_SERVICE_TARIFF (может быть несколько записей для одной услуги)"
  ]
}







