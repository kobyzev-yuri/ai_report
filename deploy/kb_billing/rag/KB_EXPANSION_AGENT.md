# –ê–≥–µ–Ω—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (KB Expansion Agent)

## –û–ø–∏—Å–∞–Ω–∏–µ

–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –ê–≥–µ–Ω—Ç:
- üîç –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∏–º–µ—Ä—ã –≤ KB
- ‚ùì –£—Ç–æ—á–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞
- üìù –°–æ–±–∏—Ä–∞–µ—Ç –Ω–æ–≤—ã–µ Q/A –ø—Ä–∏–º–µ—Ä—ã
- üéì –ü–µ—Ä–µ–æ–±—É—á–∞–µ—Ç KB —Å –Ω–æ–≤—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –î–≤–∞ –∞–≥–µ–Ω—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–µ:

1. **RAG Assistant (SQL Agent)** - –æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL
   - –ó–∞—Ç–æ—á–µ–Ω –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é SQL –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é KB –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL —á–µ—Ä–µ–∑ LLM

2. **KB Expansion Agent** - –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è KB
   - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å —É—Ç–æ—á–Ω—è—é—â–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π KB
   - –°–æ–±–∏—Ä–∞–µ—Ç –Ω–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
   - –ü–µ—Ä–µ–æ–±—É—á–∞–µ—Ç KB —Å –Ω–æ–≤—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í Streamlit –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É **"üìö –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ KB"**
2. –í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞
3. –ù–∞–∂–º–∏—Ç–µ **"üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å"**
4. –ê–≥–µ–Ω—Ç:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∏–º–µ—Ä—ã
   - –ü—Ä–µ–¥–ª–æ–∂–∏—Ç —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   - –°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –∑–∞–ø—Ä–æ—Å (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω OPENAI_API_KEY)
5. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ SQL –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä–∞
6. –ù–∞–∂–º–∏—Ç–µ **"üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä –≤ KB"**
7. –ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞–∂–º–∏—Ç–µ **"üîÑ –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å KB —Å –Ω–æ–≤—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏"**

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from kb_billing.rag.kb_expansion_agent import KBExpansionAgent

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞
agent = KBExpansionAgent()

# –ê–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–∞
analysis = agent.analyze_question_and_suggest_sql(
    question="–ü–æ–∫–∞–∂–∏ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∞–¥—Ä–µ—Å–∞–º–∏",
    api_key="your-api-key"
)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤
similar, is_duplicate = agent.check_existing_examples("–≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞")

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞
example = agent.format_example_for_kb(
    question="–í–æ–ø—Ä–æ—Å",
    sql="SELECT ...",
    category="–ö–ª–∏–µ–Ω—Ç—ã",
    complexity=2
)
agent.add_example_to_file(example)

# –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ KB
success, message = agent.retrain_kb_with_new_examples(recreate=False)
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

–ê–≥–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ö–æ–∂–µ—Å—Ç—å –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏:
- –ï—Å–ª–∏ —Å—Ö–æ–∂–µ—Å—Ç—å > 85% - —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç–æ–º
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ø–æ—Ö–æ–∂–∏–π –ø—Ä–∏–º–µ—Ä
- –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —É—Ç–æ—á–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç

### –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã

–ê–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è:
- –ü–µ—Ä–∏–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö (–º–µ—Å—è—Ü, –≥–æ–¥)
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –¢–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö (–¥–æ—Ö–æ–¥—ã, —Ä–∞—Å—Ö–æ–¥—ã, —Ç—Ä–∞—Ñ–∏–∫)
- –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º, –ø–µ—Ä–∏–æ–¥–∞–º)

### –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ KB

–ü—Ä–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–∏:
- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ `sql_examples.json` (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ)
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ Qdrant

**–í–∞–∂–Ω–æ:** –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è (`recreate=False`), –Ω–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º. –î–ª—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `recreate=True`.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–º–µ—Ä–∞

```json
{
  "question": "–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞",
  "sql": "SELECT ...",
  "context": "–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞",
  "business_entity": "customers",
  "complexity": 2,
  "category": "–ö–ª–∏–µ–Ω—Ç—ã"
}
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –∞–≥–µ–Ω—Ç–æ–º

–û–±–∞ –∞–≥–µ–Ω—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç:
- –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —ç–∫–∑–µ–º–ø–ª—è—Ä RAGAssistant –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤
- –û–¥–Ω—É –∏ —Ç—É –∂–µ KB (Qdrant –∫–æ–ª–ª–µ–∫—Ü–∏—è)
- –û–¥–Ω—É –∏ —Ç—É –∂–µ –º–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

–†–∞–∑–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏:
- **SQL Agent** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **KB Expansion Agent** - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ KB –¥–ª—è –æ–±—É—á–µ–Ω–∏—è






