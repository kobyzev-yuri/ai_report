# Методология подготовки и тестирования KB для Oracle billing

## Обзор

Этот документ описывает методологию подготовки и тестирования базы знаний (KB) для Oracle billing, основанную на проверенных подходах из проекта sql4A. Фокус на **методологии**, а не на конкретной реализации векторной БД.

---

## Часть 1: Подготовка KB

### 1.1 Структура данных KB

KB должна содержать три типа данных:

#### 1. DDL (Data Definition Language)
**Назначение:** Описание структуры таблиц и представлений Oracle

**Источники для kb_billing:**
- `oracle/tables/*.sql` - CREATE TABLE statements
- `oracle/views/*.sql` - CREATE VIEW statements
- `kb_billing/tables/*.json` - DDL из JSON файлов

**Формат:**
```sql
CREATE TABLE SPNET_TRAFFIC (
    ID NUMBER PRIMARY KEY,
    CONTRACT_ID VARCHAR2(50),
    IMEI VARCHAR2(50),
    BILL_MONTH NUMBER(6),
    ...
);
```

**Метаданные:**
- `table_name`: Имя таблицы
- `schema`: Схема (billing)
- `database`: Oracle

#### 2. Documentation (Документация)
**Назначение:** Описание бизнес-логики, правил, связей между таблицами

**Источники для kb_billing:**
- `kb_billing/tables/*.json` - описания таблиц с `key_columns`, `business_rules`
- `kb_billing/views/*.json` - описания представлений
- `kb_billing/metadata.json` - общие метаданные схемы

**Формат:**
```
Таблица: SPNET_TRAFFIC
Описание: Данные трафика SPNet - данные об использовании Iridium M2M сервисов

Ключевые поля:
- CONTRACT_ID: ID контракта - связь с биллингом (SERVICES.LOGIN). Формат: SUB-XXXXX
- IMEI: IMEI номер устройства Iridium
- BILL_MONTH: Месяц биллинга в формате YYYYMM

Бизнес-правила:
- Только записи с USAGE_TYPE = 'SBD Data Usage' считаются трафиком
- CONTRACT_ID связывается с SERVICES.LOGIN в биллинге
```

**Метаданные:**
- `table_name` или `view_name`
- `category`: Категория (Таблицы затрат, Представления, и т.д.)
- `business_domain`: Бизнес-домен (Iridium M2M сервисы, Тарификация трафика)
- `key_columns`: Список ключевых колонок

#### 3. Q/A Examples (Примеры вопрос-ответ)
**Назначение:** Примеры вопросов финансистов и соответствующих SQL запросов

**Источники для kb_billing:**
- `kb_billing/training_data/sql_examples.json`

**Формат:**
```json
{
    "question": "Покажи превышение трафика за октябрь 2025",
    "sql": "SELECT imei, contract_id, customer_name, plan_name, total_usage_kb, overage_kb, calculated_overage FROM v_consolidated_report_with_billing WHERE bill_month_yyyymm = 202510 ORDER BY calculated_overage DESC",
    "context": "Анализ превышения трафика за период",
    "business_entity": "overage",
    "complexity": 2,
    "category": "Превышение трафика"
}
```

**Метаданные:**
- `category`: Категория запроса
- `complexity`: Сложность (1-3)
- `business_entity`: Бизнес-сущность
- `table_names`: Используемые таблицы/представления
- `context`: Контекст запроса

---

### 1.2 Процесс подготовки KB

#### Этап 1: Извлечение DDL из Oracle

**Метод 1: Из SQL файлов проекта**
```python
# Читаем DDL из oracle/tables/*.sql и oracle/views/*.sql
# Уже готовы в проекте
```

**Метод 2: Из Oracle INFORMATION_SCHEMA (если нужно)**
```python
# Адаптация для Oracle (ALL_TABLES, ALL_TAB_COLUMNS)
# См. sql4A/src/tools/extract_oracle_ddl.py
```

#### Этап 2: Подготовка документации

**Из JSON файлов kb_billing:**
```python
# Читаем kb_billing/tables/*.json
# Формируем текстовую документацию из:
# - description
# - key_columns
# - business_rules
# - relationships
```

#### Этап 3: Подготовка Q/A примеров

**Источники:**
1. Существующие примеры из `kb_billing/training_data/sql_examples.json`
2. Реальные запросы финансистов (собирать в процессе использования)
3. Типовые финансовые отчеты

**Категории примеров для kb_billing:**
- **Базовые запросы** (complexity=1):
  - Поиск активных сервисов
  - Поиск по IMEI или CONTRACT_ID
  - Поиск сервисов клиента по коду 1С

- **Аналитические запросы** (complexity=2):
  - Анализ превышения трафика за период
  - Агрегация превышения по организациям
  - Статистика по тарифным планам

- **Сложные запросы** (complexity=3):
  - Выявление сервисов с высоким превышением
  - Расхождения в биллинге
  - Финансовые алерты

#### Этап 4: Загрузка в векторную БД

**Независимо от типа векторной БД (pgvector/Qdrant/Chroma):**

1. **Структурирование данных:**
   - Каждый элемент имеет: `content`, `content_type`, `metadata`
   - Метаданные в JSON формате для гибкости

2. **Генерация эмбеддингов:**
   - Модель для русского языка: `intfloat/multilingual-e5-base` (768d)
   - Или `cointegrated/rubert-tiny2` (312d) для легковесного варианта
   - Эмбеддинги генерируются для `content`

3. **Индексация:**
   - Векторный индекс для семантического поиска
   - Индексы по метаданным для фильтрации

---

## Часть 2: Тестирование KB

### 2.1 Метрики качества

#### Accuracy (Точность SQL генерации)
**Определение:** Доля вопросов, где сгенерированный SQL дает тот же результат, что и эталонный SQL.

**Метод измерения:**
1. Берем Q/A примеры из KB
2. Генерируем SQL для каждого вопроса
3. Выполняем оба SQL (сгенерированный и эталонный) в Oracle
4. Сравниваем результаты

**Целевое значение:** > 0.8 (80% точность)

#### Top-k Hit Rate (Точность ретривера)
**Определение:** Доля вопросов, где релевантный фрагмент из KB попал в top-k результатов поиска.

**Метод измерения:**
1. Берем вопрос из KB
2. Ищем похожие примеры в KB (семантический поиск)
3. Проверяем, попал ли эталонный SQL в top-k

**Целевое значение:** 
- Top-1: > 0.6 (60%)
- Top-3: > 0.8 (80%)
- Top-5: > 0.9 (90%)

#### MRR (Mean Reciprocal Rank)
**Определение:** Усредненная обратная позиция первого релевантного результата.

**Формула:** `MRR = (1/n) * Σ(1/rank_i)`

**Целевое значение:** > 0.7

### 2.2 Наборы тестов

#### Seen (Виденные примеры)
**Описание:** Исходные вопросы из KB (content_type='qa_example')

**Цель:** Проверить, что система может воспроизвести примеры, на которых обучалась.

**Ожидаемый результат:** Accuracy > 0.9

#### Paraphrases (Перефразы)
**Описание:** Перефразы исходных вопросов (3-10 вариантов каждого)

**Цель:** Проверить устойчивость к формулировкам.

**Примеры перефразов:**
- Оригинал: "Покажи превышение трафика за октябрь 2025"
- Перефразы:
  - "Выведи данные по превышению трафика в октябре 2025"
  - "Какое превышение трафика было в октябре 2025?"
  - "Отчет по превышению трафика за октябрь 2025 года"

**Ожидаемый результат:** Accuracy > 0.7

#### Новые вопросы (Unseen)
**Описание:** Вопросы, которых нет в KB

**Цель:** Проверить способность к обобщению.

**Ожидаемый результат:** Accuracy > 0.6

### 2.3 Критерии корректности SQL

#### 1. Синтаксическая валидность
- SQL должен быть валидным для Oracle
- Не должно быть синтаксических ошибок

#### 2. Execution Equivalence (Эквивалентность выполнения)
- Результаты выполнения сгенерированного SQL должны совпадать с эталонным
- Порядок строк может отличаться (сравниваем множества)

#### 3. Оптимизация (опционально)
- Сравнение EXPLAIN планов
- Проверка использования индексов
- Время выполнения

### 2.4 Процесс тестирования

#### Шаг 1: Подготовка тестового набора

```python
# Извлечь все Q/A примеры из KB
test_questions = [
    {
        "question": "Покажи превышение трафика за октябрь 2025",
        "sql_expected": "SELECT ... FROM v_consolidated_report_with_billing ...",
        "category": "Превышение трафика",
        "complexity": 2
    },
    # ...
]

# Сгенерировать перефразы (через LLM или шаблоны)
paraphrases = generate_paraphrases(test_questions, n=5)
```

#### Шаг 2: Генерация SQL

```python
for question in test_questions + paraphrases:
    # RAG: поиск релевантных примеров
    relevant_examples = search_kb(question, top_k=5)
    
    # Генерация SQL с контекстом
    sql_generated = llm.generate_sql(
        question=question,
        context=format_context(relevant_examples)
    )
    
    # Сохранение результата
    results.append({
        "question": question,
        "sql_expected": question["sql_expected"],
        "sql_generated": sql_generated,
        "relevant_examples": relevant_examples
    })
```

#### Шаг 3: Валидация

```python
# Выполнение SQL в Oracle
for result in results:
    # Выполняем эталонный SQL
    expected_result = execute_oracle_sql(result["sql_expected"])
    
    # Выполняем сгенерированный SQL
    try:
        generated_result = execute_oracle_sql(result["sql_generated"])
        
        # Сравнение результатов
        is_equal = compare_results(expected_result, generated_result)
        result["accuracy"] = 1.0 if is_equal else 0.0
        
    except Exception as e:
        result["accuracy"] = 0.0
        result["error"] = str(e)
```

#### Шаг 4: Анализ и рекомендации

```python
# Расчет метрик
accuracy = sum(r["accuracy"] for r in results) / len(results)
top_k_hit_rate = calculate_hit_rate(results, k=5)

# Анализ ошибок
error_analysis = analyze_errors(results)
# - Какие таблицы чаще всего используются в ошибках?
# - Какие категории вопросов дают низкую точность?
# - Какие типы ошибок встречаются?

# Рекомендации
recommendations = generate_recommendations(error_analysis)
# - Добавить больше примеров для слабых категорий
# - Добавить DDL для недостающих таблиц
# - Расширить документацию для проблемных областей
```

---

## Часть 3: Адаптация для Oracle billing

### 3.1 Особенности Oracle

#### Синтаксис SQL
- **Даты:** `TO_DATE('202510', 'YYYYMM')` вместо `DATE '2025-10-01'`
- **Строки:** `VARCHAR2` вместо `VARCHAR`
- **Числа:** `NUMBER` вместо `INTEGER` или `DECIMAL`
- **Ограничения:** `ROWNUM <= 10` вместо `LIMIT 10`

#### Представления (VIEW)
- Используются активно: `V_CONSOLIDATED_REPORT_WITH_BILLING`
- Важно включать DDL представлений в KB

#### Связи с биллингом
- Доступ к таблицам биллинга через `SERVICES`, `ACCOUNTS`, `CUSTOMERS`
- Важно документировать связи между таблицами

### 3.2 Специфичные метаданные для billing

#### Категории запросов:
- **Превышение трафика** - расчет и анализ превышений
- **Финансовые отчеты** - себестоимость, доходы
- **Сервисы** - поиск и сверка услуг
- **Клиенты** - информация о клиентах
- **Финансовые алерты** - выявление проблем

#### Бизнес-сущности:
- `overage` - превышение трафика
- `services` - сервисы Iridium
- `customers` - клиенты
- `billing` - биллинг
- `reports` - финансовые отчеты

#### Сложность:
- **1** - простые SELECT с фильтрами
- **2** - JOIN, агрегации, подзапросы
- **3** - сложные аналитические запросы, оконные функции

### 3.3 Типовые запросы финансистов

#### Финансовые отчеты:
```
"Покажи себестоимость услуг за октябрь 2025"
"Выведи доходы из счетов-фактур по клиентам"
"Сравни затраты и доходы по периодам"
```

#### Поиск соответствий:
```
"Найди все услуги клиента по коду 1С 1C00123"
"Покажи соответствие услуг в Иридиум и Стэкком"
"Найди сервисы без трафика за последние 3 месяца"
```

#### Аналитика:
```
"Топ-10 клиентов по превышению трафика"
"Статистика по тарифным планам"
"Расхождения между рассчитанным и выставленным превышением"
```

---

## Часть 4: Рекомендации по улучшению KB

### 4.1 На основе метрик

#### Низкая Accuracy (< 0.7)
**Причины:**
- Недостаточно примеров для категории
- Неполная документация по таблицам
- Отсутствие DDL для используемых таблиц

**Действия:**
1. Добавить больше Q/A примеров для проблемных категорий
2. Расширить документацию по таблицам
3. Добавить DDL для недостающих таблиц/представлений

#### Низкий Top-k Hit Rate (< 0.6)
**Причины:**
- Плохое качество эмбеддингов
- Недостаточно контента в KB
- Неправильная категоризация

**Действия:**
1. Проверить модель эмбеддингов (возможно, нужна другая)
2. Добавить больше примеров и документации
3. Улучшить метаданные (категории, теги)

### 4.2 На основе анализа ошибок

#### Частые ошибки с определенными таблицами
**Действие:** Добавить больше примеров и документации для этих таблиц

#### Ошибки в JOIN операциях
**Действие:** Добавить примеры с JOIN и документировать связи между таблицами

#### Ошибки в агрегациях
**Действие:** Добавить примеры с GROUP BY, агрегатными функциями

### 4.3 Итеративный процесс улучшения

```
1. Загрузка KB
   ↓
2. Тестирование (benchmark)
   ↓
3. Анализ метрик и ошибок
   ↓
4. Генерация рекомендаций
   ↓
5. Добавление данных (примеры, документация, DDL)
   ↓
6. Регенерация эмбеддингов
   ↓
7. Повторное тестирование
   ↓
8. Сравнение метрик (улучшение?)
```

---

## Часть 5: Практические шаги для kb_billing

### Шаг 1: Подготовка данных

```python
# 1. Извлечь DDL из oracle/tables/*.sql и oracle/views/*.sql
# 2. Подготовить документацию из kb_billing/tables/*.json
# 3. Загрузить Q/A примеры из kb_billing/training_data/sql_examples.json
```

### Шаг 2: Загрузка в векторную БД

```python
# Независимо от типа векторной БД:
# - Структурировать данные (content, content_type, metadata)
# - Сгенерировать эмбеддинги
# - Создать индексы
```

### Шаг 3: Тестирование

```python
# 1. Подготовить тестовый набор (seen + paraphrases)
# 2. Запустить benchmark
# 3. Проанализировать метрики
# 4. Сгенерировать рекомендации
```

### Шаг 4: Итеративное улучшение

```python
# На основе рекомендаций:
# - Добавить недостающие примеры
# - Расширить документацию
# - Улучшить метаданные
# - Повторить тестирование
```

---

## Заключение

Методология подготовки и тестирования KB не зависит от конкретной реализации векторной БД. Ключевые принципы:

1. **Три типа данных:** DDL, Documentation, Q/A Examples
2. **Структурированные метаданные:** для фильтрации и категоризации
3. **Регулярное тестирование:** метрики Accuracy, Top-k Hit Rate, MRR
4. **Итеративное улучшение:** на основе анализа ошибок и рекомендаций

Для Oracle billing важно:
- Учитывать синтаксис Oracle SQL
- Документировать связи с биллингом
- Фокусироваться на финансовых отчетах и поиске соответствий
- Использовать категории и бизнес-сущности специфичные для billing















