# ИСПРАВЛЕННАЯ конфигурация nginx для проксирования Streamlit
# Используйте эту конфигурацию вместо текущей
#
# ВАЖНО: Если nginx на той же машине (vz2), используйте localhost:8504
#        Если nginx на другой машине, используйте 82.114.2.2:8504

server {
    listen 7776;
    server_name stat.steccom.ru ural.stat.steccom.ru;

    # Логирование для отладки
    access_log /var/log/nginx/streamlit_ai_report_access.log;
    error_log /var/log/nginx/streamlit_ai_report_error.log debug;

    # Увеличиваем размер буферов для больших ответов
    client_max_body_size 50M;
    proxy_buffering off;
    proxy_request_buffering off;

    # КРИТИЧНО: Проксирование основного приложения Streamlit
    # Перезапись путей убирает /ai_report перед проксированием
    location /ai_report/ {
        # Убираем /ai_report из пути перед проксированием
        rewrite ^/ai_report/(.*)$ /$1 break;
        rewrite ^/ai_report$ / break;
        
        # ИСПРАВЛЕНО: порт 8504 (не 8501!)
        # Если nginx на той же машине, используйте localhost
        # Если на другой машине, используйте 82.114.2.2
        proxy_pass http://localhost:8504;
        # Или если nginx на другой машине:
        # proxy_pass http://82.114.2.2:8504;
        
        proxy_http_version 1.1;
        proxy_redirect off;
        
        # Заголовки для проксирования
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket поддержка (критично для Streamlit!)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # Таймауты для WebSocket
        proxy_read_timeout 86400;
        proxy_connect_timeout 86400;
        proxy_send_timeout 86400;
        
        # Отключаем кэширование для Streamlit
        proxy_cache_bypass $http_upgrade;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # КРИТИЧНО: Проксирование WebSocket соединений (должно быть ДО основного location!)
    location /ai_report/_stcore/stream {
        # Убираем /ai_report из пути
        rewrite ^/ai_report/_stcore/stream$ /_stcore/stream break;
        
        proxy_pass http://localhost:8504;
        # Или если nginx на другой машине:
        # proxy_pass http://82.114.2.2:8504;
        
        proxy_http_version 1.1;
        
        # WebSocket заголовки
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Длинные таймауты для WebSocket
        proxy_read_timeout 86400;
        proxy_connect_timeout 86400;
        proxy_send_timeout 86400;
        
        # Отключаем буферизацию для WebSocket
        proxy_buffering off;
    }

    # Проксирование других _stcore endpoints (host-config, health и т.д.)
    location /ai_report/_stcore/ {
        rewrite ^/ai_report/_stcore/(.*)$ /_stcore/$1 break;
        
        proxy_pass http://localhost:8504;
        # Или если nginx на другой машине:
        # proxy_pass http://82.114.2.2:8504;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket поддержка для некоторых endpoints
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        proxy_read_timeout 86400;
        proxy_connect_timeout 86400;
        proxy_send_timeout 86400;
    }

    # Проксирование статических файлов Streamlit
    location /ai_report/_static/ {
        rewrite ^/ai_report/_static/(.*)$ /_static/$1 break;
        
        proxy_pass http://localhost:8504;
        # Или если nginx на другой машине:
        # proxy_pass http://82.114.2.2:8504;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Кэширование статики
        expires 1d;
        add_header Cache-Control "public, immutable";
    }

    # Health check endpoint
    location /ai_report/health {
        proxy_pass http://localhost:8504/_stcore/health;
        # Или если nginx на другой машине:
        # proxy_pass http://82.114.2.2:8504/_stcore/health;
        access_log off;
    }

    # Корневой путь - редирект на /ai_report/
    location = /ai_report {
        return 301 /ai_report/;
    }
}

# Переменная для правильной обработки WebSocket
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}



